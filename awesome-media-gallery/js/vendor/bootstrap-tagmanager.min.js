!function(a){"use strict";("undefined"==typeof console||"undefined"==typeof console.log)&&(console={},console.log=function(){}),a.fn.tagsManager=function(e,t){var n={prefilled:null,CapitalizeFirstLetter:!1,preventSubmitOnEnter:!0,isClearInputOnEsc:!0,typeahead:!1,typeaheadAjaxMethod:"POST",typeaheadAjaxSource:null,typeaheadAjaxPolling:!1,typeaheadOverrides:null,typeaheadDelegate:{},typeaheadSource:null,AjaxPush:null,AjaxPushAllTags:null,AjaxPushParameters:null,delimiters:[9,13,44],backspace:[8],maxTags:0,hiddenTagListName:null,hiddenTagListId:null,deleteTagsOnBackspace:!0,tagsContainer:null,tagCloseIcon:"Ã—",tagClass:"",validator:null,onlyTagList:!1},i=function(){function e(){this.instanceSelectHandler=null,this.selectedClass="selected",this.select=null,"typeahead"in a.fn&&(this.instanceSelectHandler=a.fn.typeahead.Constructor.prototype.select,this.select=function(a){this.$menu.find(".active").addClass(a.selectedClass),a.instanceSelectHandler.apply(this,arguments)})}return e}();if(!(0 in this))return this;n.typeaheadOverrides=new i,a.extend(n,e),null===n.hiddenTagListName&&(n.hiddenTagListName="hidden-"+this.attr("name"));var r=this,s=r.attr("name").replace(/[^\w]/g,"_"),l=n.delimeters||n.delimiters,o=[9,13,17,18,19,37,38,39,40],d=[],u=[];a.each(l,function(e,t){-1!=a.inArray(t,o)?u.push(t):d.push(t)});var c=String.fromCharCode(d[0]||44),p=n.backspace,h="tm-tag",g="tm-input";a.isFunction(n.validator)&&r.data("validator",n.validator);var f=function(){if(r.typeahead){var e=n.typeaheadDelegate;null!==n.typeaheadSource&&a.isFunction(n.typeaheadSource)?(a.extend(e,{source:n.typeaheadSource}),r.typeahead(e)):null!==n.typeaheadSource?(r.typeahead(e),v(n.typeaheadSource)):null!==n.typeaheadAjaxSource&&(n.typeaheadAjaxPolling?n.typeaheadAjaxPolling&&(a.extend(e,{source:T}),r.typeahead(e)):(r.typeahead(e),"string"==typeof n.typeaheadAjaxSource&&a.ajax({cache:!1,type:n.typeaheadAjaxMethod,contentType:"application/json",dataType:"json",url:n.typeaheadAjaxSource,data:JSON.stringify({typeahead:""}),success:function(a){y(a,!0)}})));var t=r.data("typeahead");t&&(t.select=a.proxy(n.typeaheadOverrides.select,r.data("typeahead"),n.typeaheadOverrides))}},y=function(e,t,n){if("d"in e&&(e=e.d),e&&e.tags){var i=[];i.length=0,a.each(e.tags,function(a,e){i.push(e.tag),t&&v(i)}),a.isFunction(n)&&n(i)}},v=function(a){r.data("active",!0),r.data("typeahead").source=a,n.typeaheadSource=a,r.data("active",!1)},m=function(){var a="."+n.typeaheadOverrides.selectedClass,e=r.data("typeahead");return e?e.$menu.find(a):void 0},C=function(){return a(".typeahead:visible")[0]},T=function(e,t){"string"==typeof n.typeaheadAjaxSource&&a.ajax({cache:!1,type:n.typeaheadAjaxMethod,contentType:"application/json",dataType:"json",url:n.typeaheadAjaxSource,data:JSON.stringify({typeahead:e}),success:function(a){y(a,!1,t)}})},x=function(){var e=h;return r.attr("class")&&a.each(r.attr("class").split(" "),function(a,t){-1!=t.indexOf(g+"-")&&(e+=" "+h+t.substring(g.length))}),e+=n.tagClass?" "+n.tagClass:""},A=function(e){e=a.trim(e);var t=0;for(t;t<e.length&&-1==a.inArray(e.charCodeAt(t),d);t++);return e.substring(0,t)},j=function(){var e=r.data("tlis"),t=r.data("tlid");if(t.length>0){var n=t.pop();e.pop(),a("#"+s+"_"+n).remove(),S()}},b=function(){for(var e=r.data("tlis"),t=r.data("tlid");t.length>0;){var n=t.pop();e.pop(),a("#"+s+"_"+n).remove(),S()}},S=function(){var e=r.data("tlis"),t=r.data("lhiddenTagList");r.trigger("tags:refresh",e.join(c)),t&&a(t).val(e.join(c)).change()},k=function(e){var t=r.data("tlis"),i=r.data("tlid"),l=a.inArray(e,i);-1!=l&&(a("#"+s+"_"+e).remove(),t.splice(l,1),i.splice(l,1),S()),n.maxTags>0&&t.length<n.maxTags&&r.show()},L=function(e,t){n.AjaxPushAllTags&&a.post(n.AjaxPush,{tags:t})},w=function(e){if(e=A(e),e&&!(e.length<=0)){if(null!==n.typeaheadSource){var t=a.isFunction(n.typeaheadSource)?n.typeaheadSource():n.typeaheadSource;if(n.onlyTagList&&-1==a.inArray(e,t))return}if(n.CapitalizeFirstLetter&&e.length>1&&(e=e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()),!r.data("validator")||r.data("validator")(e)){var i=r.data("tlis"),l=r.data("tlid");if(!(n.maxTags>0&&i.length>=n.maxTags)){var o=!1,d=a.map(i,function(a){return a.toLowerCase()}),u=a.inArray(e.toLowerCase(),d);if(-1!=u&&(o=!0),o){var c=l[u];a("#"+s+"_"+c).stop().animate({backgroundColor:n.blinkBGColor_1},100).animate({backgroundColor:n.blinkBGColor_2},100).animate({backgroundColor:n.blinkBGColor_1},100).animate({backgroundColor:n.blinkBGColor_2},100).animate({backgroundColor:n.blinkBGColor_1},100).animate({backgroundColor:n.blinkBGColor_2},100)}else{var p=Math.max.apply(null,l);p=p==-1/0?0:p;var h=++p;i.push(e),l.push(h),null!==n.AjaxPush&&a.post(n.AjaxPush,a.extend({tag:e},n.AjaxPushParameters));var g=s+"_"+h,f=s+"_Remover_"+h,y=a("<span></span>").text(e).html(),v='<span class="'+x()+'" id="'+g+'">';v+="<span>"+y+"</span>",v+='<a href="#" class="tm-tag-remove" id="'+f+'" TagIdToRemove="'+h+'">',v+=n.tagCloseIcon+"</a></span> ";var m=a(v);null!==n.tagsContainer?a(n.tagsContainer).append(m):r.before(m),m.find("#"+f).on("click",r,function(e){e.preventDefault();var t=parseInt(a(this).attr("TagIdToRemove"),10);k(t,e.data)}),S(),n.maxTags>0&&i.length>=n.maxTags&&r.hide()}r.val("")}}}},O=function(e){a.each(e,function(a,e){w(e)})},P=function(a){a.cancelBubble=!0,a.returnValue=!1,a.stopPropagation(),a.preventDefault()},_=function(e,t){return-1!=a.inArray(e.which,t)},I=function(a){var e=m(),t=C();13==a.which&&e&&t||w(r.val()),a.preventDefault()};return this.each(function(){if("string"!=typeof e){if(a(this).data("tagManager"))return!1;a(this).data("tagManager",!0);var i=[],s=[];if(r.data("tlis",i),r.data("tlid",s),null===n.hiddenTagListId){var l=a("input[name='"+n.hiddenTagListName+"']");l.length>0&&l.remove();var o="";o+="<input name='"+n.hiddenTagListName+"' type='hidden' value=''/>",r.after(o),r.data("lhiddenTagList",r.siblings("input[name='"+n.hiddenTagListName+"']")[0])}else r.data("lhiddenTagList",a("#"+n.hiddenTagListId));n.typeahead&&f(),n.AjaxPushAllTags&&r.on("tags:refresh",L),r.on("focus keypress",function(){a(this).data("popover")&&a(this).popover("hide")}),n.isClearInputOnEsc&&r.on("keyup",function(e){27==e.which&&(a(this).val(""),P(e))}),r.on("keypress",function(a){_(a,d)&&I(a)}),r.on("keydown",function(a){if(13==a.which&&n.preventSubmitOnEnter&&P(a),_(a,u)){var e=A(r.val());if((!e||e.length<=0)&&9==a.which)return;I(a)}}),n.deleteTagsOnBackspace&&r.on("keydown",function(e){_(e,p)&&a(this).val().length<=0&&(j(),P(e))}),r.change(function(e){/webkit/.test(navigator.userAgent.toLowerCase())||a(this).focus();var t=m(),i=C();t&&i&&(t.removeClass(n.typeaheadOverrides.selectedClass),w(t.attr("data-value"))),P(e)}),null!==n.prefilled?"object"==typeof n.prefilled?O(n.prefilled):"string"==typeof n.prefilled?O(n.prefilled.split(c)):"function"==typeof n.prefilled&&O(n.prefilled()):null!==n.hiddenTagListId&&O(a("#"+n.hiddenTagListId).val().split(c)),r.data("tagManager-options",n)}else switch(n=r.data("tagManager-options"),e){case"empty":b();break;case"popTag":j();break;case"pushTag":w(t)}})}}(jQuery);